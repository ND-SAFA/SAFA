<template>
  <details-panel panel="saveTrace" data-cy="panel-trace-save">
    <artifact-input
      v-model="sourceArtifactId"
      label="Source Artifact"
      :multiple="false"
      data-cy="button-trace-save-source"
      class="my-4"
    />
    <artifact-input
      v-model="targetArtifactId"
      label="Target Artifact"
      :multiple="false"
      data-cy="button-trace-save-target"
      class="my-4"
    />

    <v-expansion-panels>
      <v-expansion-panel data-cy="panel-trace-directions">
        <v-expansion-panel-title>
          <typography value="Allowed Trace Directions" />
        </v-expansion-panel-title>
        <v-expansion-panel-text>
          <div v-for="entry in artifactLevels" :key="entry.typeId">
            <type-direction-input :artifact-level="entry" />
          </div>
        </v-expansion-panel-text>
      </v-expansion-panel>
    </v-expansion-panels>

    <v-divider class="my-4" />
    <flex-box justify="between" align="center">
      <typography color="error" r="2" :value="errorMessage" />
      <v-btn
        color="primary"
        :disabled="!canSave"
        data-cy="button-trace-save"
        @click="handleSubmit"
      >
        Create
      </v-btn>
    </flex-box>
  </details-panel>
</template>

<script lang="ts">
import { defineComponent } from "vue";
import { ArtifactSchema, TimArtifactLevelSchema } from "@/types";
import { appStore, artifactStore, traceStore, typeOptionsStore } from "@/hooks";
import { handleCreateLink } from "@/api";
import {
  Typography,
  ArtifactInput,
  TypeDirectionInput,
  FlexBox,
} from "@/components/common";
import DetailsPanel from "@/components/navigation/detailsDrawer/DetailsPanel.vue";

/**
 * Allows for creating trace links.
 */
export default defineComponent({
  name: "SaveTraceLinkPanel",
  components: {
    DetailsPanel,
    FlexBox,
    Typography,
    ArtifactInput,
    TypeDirectionInput,
  },
  data() {
    return {
      sourceArtifactId: "",
      targetArtifactId: "",
    };
  },
  computed: {
    /**
     * @return Whether this panel is open.
     */
    isOpen(): boolean {
      return appStore.isDetailsPanelOpen === "saveTrace";
    },

    /**
     * @return The source artifact.
     */
    sourceArtifact(): ArtifactSchema | undefined {
      return artifactStore.getArtifactById(this.sourceArtifactId);
    },
    /**
     * @return The source artifact.
     */
    targetArtifact(): ArtifactSchema | undefined {
      return artifactStore.getArtifactById(this.targetArtifactId);
    },
    /**
     * @return Any errors in trying to create this link.
     */
    errorMessage(): string {
      const source = this.sourceArtifact;
      const target = this.targetArtifact;

      if (!source || !target) return "";

      const isLinkAllowed = traceStore.isLinkAllowed(source, target);

      return isLinkAllowed === true
        ? ""
        : isLinkAllowed || "Cannot create a trace link.";
    },
    /**
     * @return Whether a link can be created.
     */
    canSave(): boolean {
      return (
        !!this.sourceArtifactId &&
        !!this.targetArtifactId &&
        this.errorMessage === ""
      );
    },
    /**
     * @return The current project's artifact types.
     */
    artifactLevels(): TimArtifactLevelSchema[] {
      return typeOptionsStore.artifactLevels;
    },
  },
  watch: {
    /**
     * Resets fields when the panel opens.
     */
    isOpen(open: boolean) {
      const openState = appStore.isTraceCreatorOpen;

      if (!open) return;

      this.sourceArtifactId = "";
      this.targetArtifactId = "";

      if (typeof openState !== "object") return;

      if (openState.type === "source") {
        this.sourceArtifactId = openState.artifactId;
      } else if (openState.type === "target") {
        this.targetArtifactId = openState.artifactId;
      } else {
        this.sourceArtifactId = openState.sourceId;
        this.targetArtifactId = openState.targetId;
      }
    },
  },
  methods: {
    /**
     * Creates a trace link from the given artifacts.
     */
    async handleSubmit(): Promise<void> {
      const source = this.sourceArtifact;
      const target = this.targetArtifact;

      if (!source || !target) return;

      await handleCreateLink(source, target);
      this.handleClose();
    },
    /**
     * Closes the trace link creator.
     */
    handleClose(): void {
      appStore.closeSidePanels();
    },
  },
});
</script>
