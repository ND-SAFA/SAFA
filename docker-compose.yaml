version: '3'
services:
  proxy:
    image: nginx:alpine
    container_name: proxy
    depends_on: ["fend", "bend"]
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "80:80"        # later: "443:443" with TLS
    networks: [safa]

  fend:
    build:
      context: ./fend
      args:
        # Frontend should call relative path so it stays same-origin
        API_ENDPOINT: /api
        DEMO_EMAIL: ${DEMO_EMAIL:-}
        DEMO_PASSWORD: ${DEMO_PASSWORD:-}
        DEMO_PROJECT_VERSION: ${DEMO_PROJECT_VERSION:-}
    ports: []           # no public exposure
    networks: [safa]

  bend:
    depends_on: ["mysql"]
    build:
      context: ./bend
    # expose port only inside docker network
    expose:
      - "80"
    environment:
      - TGEN_ENDPOINT=http://gen:80
      - DB_URL=jdbc:mysql://mysql/safa-db
    networks: [safa]

  gen:
    depends_on: ["redis"]
    build:
      context: ./gen-api
      dockerfile: Dockerfile
      args: { TASK_MANAGER: redis }
    env_file: [.env]
    expose:
      - "80"
    volumes:
      - tgen-volume:/vol
      - ~/.cache/models:/root/.cache/huggingface/datasets
    networks: [safa]
    environment:
      - DEBUG=false
      - ENV_MODE=development
      - N_WORKERS=2
      - DEFAULT_CROSS_ENCODER_MODEL=cross-encoder/ms-marco-TinyBERT-L-2
      - DEFAULT_EMBEDDING_MODEL=sentence-transformers/all-MiniLM-L6-v2
      - BROKER=redis
      - BROKER_URL=redis://redis:6379/0
      - BROKER_USERNAME=guest
      - BROKER_PASSWORD=guest
      - HF_DATASETS_CACHE=/root/.cache/huggingface/datasets
      - BEND_URL=http://bend:80
      - JWT_TOKEN=change-me
      - SECRET_KEY=change-me

  redis:
    image: redis:alpine
    networks: [safa]
    # no ports -> private

  mysql:
    image: mysql:8.0
    hostname: mysql
    container_name: mysql
    deploy:
      resources:
        limits: { memory: 1G }
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-safa-db}
    volumes:
      - ./bend/my.cnf:/etc/mysql/my.cnf
      - db_data:/var/lib/mysql
    networks: [safa]
    # no ports -> private

volumes:
  db_data:
  tgen-volume:
    name: tgen-volume

networks:
  safa:
