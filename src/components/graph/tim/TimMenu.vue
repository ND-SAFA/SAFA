<template>
  <node-display
    v-if="displayActions"
    variant="menu"
    color="neutral"
    @mousedown.stop
    @mouseup.stop
  >
    <flex-box>
      <icon-button
        :tooltip="
          drawMode ? 'Cancel draw mode' : 'Draw artifact type direction'
        "
        :icon="drawMode ? 'cancel' : 'trace'"
        @click="handleAction(() => cyStore.drawMode('toggle'))"
      />
      <separator v-if="displayGenerateActions" vertical class="q-mx-xs" />
      <icon-button
        v-if="displayGenerateActions"
        tooltip="Summarize artifacts"
        icon="generate-summaries"
        color="gradient"
        data-cy="button-summarize-artifact"
        @click="
          handleAction(() => appStore.openDetailsPanel('summarizeArtifact'))
        "
      />
      <icon-button
        v-if="displayGenerateActions"
        tooltip="Generate artifacts"
        icon="generate-artifacts"
        color="gradient"
        @click="
          handleAction(() => appStore.openDetailsPanel('generateArtifact'))
        "
      />
      <icon-button
        v-if="displayGenerateActions"
        tooltip="Generate trace links"
        icon="generate-traces"
        color="gradient"
        @click="handleAction(() => appStore.openDetailsPanel('generateTrace'))"
      />
    </flex-box>
  </node-display>
</template>

<script lang="ts">
/**
 * Renders a context menu for the tim tree.
 */
export default {
  name: "TimMenu",
};
</script>

<script setup lang="ts">
import { computed, inject } from "vue";
import { appStore, cyStore, permissionStore } from "@/hooks";
import { FlexBox, IconButton, Separator } from "@/components/common";
import { NodeDisplay } from "@/components/graph/display";

const handleCloseMenu = inject<() => void>("menu-close");

const drawMode = computed(() => appStore.popups.drawTrace);

const displayActions = computed(() =>
  permissionStore.isAllowed("project.edit_data")
);
const displayGenerateActions = computed(() =>
  permissionStore.isAllowed("project.generate")
);

/**
 * Handles a menu action and closes the menu.
 * @param action - The action to handle.
 */
function handleAction(action: () => void): void {
  action();
  handleCloseMenu?.();
}
</script>
